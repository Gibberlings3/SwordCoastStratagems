//////////////////////////////////////////////////////////////////////////////////////
///	I'm a lich
///////////////////////////////////////////////////////////////////////////////////

VARIABLE(IsLich=True)
VARIABLE(IsNormalWeaponImmune=True)

IF
	!Global("LichImmunities","LOCALS",1)
THEN
	RESPONSE #100
		SetGlobal("LichImmunities","LOCALS",1)
		ApplySpellRES("dw#licim",Myself) // some evidence this works better than lich01 ring
		Continue()
END

//////////////////////////////////////////////////////////////////////////////////
///
///   Define actions
///
////////////////////////////////////////////////////////////////////////////////////////

BEGIN LOOP(!StateCheck\(scstarget,STATE_NOT_TARGETABLE\)|| )
BEGIN LOOP(!StateCheck\(scstarget,STATE_INVISIBLE\) || )
	INCLUDE FILE(%scsroot%/caster_shared/caster_definitions.ssl)
END LOOP
END LOOP

INCLUDE FILE(%scsroot%/mage/ssl/main/preamble.ssl)


/////////////////////////////////////////////////////////////////
/////	Demiliches block pro/undead scrolls
/////////////////////////////////////////////////////////////////

IF
       RequireBlock(IsDemilich)
       !GlobalTimerNotExpired("blockproundead","LOCALS")
       See(NearestEnemyOf(Myself))
THEN
       RESPONSE #100
           ApplySpellRES("dw#nprun",Player1)
           ApplySpellRES("dw#nprun",Player2)
           ApplySpellRES("dw#nprun",Player3)
           ApplySpellRES("dw#nprun",Player4)
           ApplySpellRES("dw#nprun",Player5)
           ApplySpellRES("dw#nprun",Player6)
           SetGlobalTimer("blockproundead","LOCALS",300)
           Continue()
END


//////////////////////////////////////////////////////////////////////////////////////
///    lich fear aura; demilich howl
///////////////////////////////////////////////////////////////////////////////////

IF TRIGGER
        IgnoreBlock(IsDemilich)
        See(NearestEnemyOf(Myself))
        !GlobalTimerNotExpired("fearaura","LOCALS")
        !CheckSpellState(Myself,TIME_STOP)
        !GlobalTimerNotExpired("DMWWTimeStopRunning","GLOBAL")
        TriggerBlock(CorePlus)
THEN DO
                 Action(Literal)
                 SetGlobalTimer("fearaura","LOCALS",6)
                 ReallyForceSpellRES("dw#licfi",Myself)
                 Continue()
END

IF TRIGGER
        RequireBlock(IsDemilich)
        See(NearestEnemyOf(Myself))
        !GlobalTimerNotExpired("howl","LOCALS")
        !CheckSpellState(Myself,TIME_STOP)
        !GlobalTimerNotExpired("DMWWTimeStopRunning","GLOBAL")
THEN DO
                 Action(Literal)
                 SetGlobalTimer("howl","LOCALS",60)
                 ReallyForceSpell(Myself,DEMILICH_DEATH)
                 Continue()
END



//////////////////////////////////////////////////////////////////////////////////
////	Setup, prep
//////////////////////////////////////////////////////////////////////////////////

INCLUDE FILE(%scsroot%/mage/ssl/main/magesetup.ssl)

////////////////////////////////////////////////////////////////////////////
///	Contingencies renew defences
////////////////////////////////////////////////////////////////////////////

INCLUDE FILE(%scsroot%/mage/ssl/generalblocks/contingency.ssl)

////////////////////////////////////////////////////////////////////////////
///	No CPU saver or non-hostile closedown for liches - they're basically
///     always hostile and the CPU saver interacts badly with Protection from Undead scrolls
////////////////////////////////////////////////////////////////////////////



///////////////////////////////////////////////////////////////////////////
////	Flee clouds (IgnoreBlocks screen out the ones that don't apply)
///////////////////////////////////////////////////////////////////////////

INCLUDE FILE(%scsroot%/mage/ssl/generalblocks/fleecloud.ssl)


////////////////////////////////////////////////////////////////////////////////////////
////	Kill the timer if we're using Alacrity
////////////////////////////////////////////////////////////////////////////////////////

IF
        SSLBoolean(WIZARD_IMPROVED_ALACRITY|WIZARD_WISH)
	CheckStatGT(Myself,0,WIZARD_IMPROVED_ALACRITY)
	GlobalTimerNotExpired("castspell","LOCALS")
THEN
	RESPONSE #100
		SetGlobalTimer("castspell","LOCALS",0)
END

//////////////////////////////////////////////////////////////////////////////////////
///    demilich soul trap
///////////////////////////////////////////////////////////////////////////////////

INCLUDE FILE(%scsroot%/mage/ssl/combatblocks/trap_the_soul.ssl)

///////////////////////////////////////////////////////////////////////////
//	Melee
///////////////////////////////////////////////////////////////////////////

INCLUDE FILE(%scsroot%/mage/ssl/generalblocks/melfsetup.ssl)
INCLUDE FILE(%scsroot%/mage/ssl/meleeblocks/standard_mage.ssl)

//////////////////////////////////////////////////////////////////////////
// Renew and retreat
//////////////////////////////////////////////////////////////////////////

DEFAULT TRIGGER()
INCLUDE FILE(%scsroot%/mage/ssl/generalblocks/renew.ssl)

//////////////////////////////////////////////////////////////////////////
// Easiest-level block
//////////////////////////////////////////////////////////////////////////

DEFAULT TRIGGER()
INCLUDE FILE(%scsroot%/mage/ssl/generalblocks/easy.ssl)



//////////////////////////////////////////////////////////////////////////
// Look for PCs
//////////////////////////////////////////////////////////////////////////

DEFAULT TRIGGER(!GlobalTimerNotExpired("castspell","LOCALS"))

INCLUDE FILE(%scsroot%/mage/ssl/generalblocks/chase.ssl)

////////////////////////////////////////////////////////////////////////////
// Core magic block
///////////////////////////////////////////////////////////////////////////

DEFAULT TRIGGER()
INCLUDE FILE(%scsroot%/mage/ssl/magetypes/ssl_mage_type.ssl)

////////////////////////////////////////////////////////////////////////////
// Deactivate alacrity instruction for fast casting if relevant
///////////////////////////////////////////////////////////////////////////

IF
	SSLBoolean(WIZARD_IMPROVED_ALACRITY|WIZARD_WISH)
        ActionListEmpty()
	CheckStatGT(Myself,0,WIZARD_IMPROVED_ALACRITY)
THEN
	RESPONSE #100
		SetGlobal("alacritycompromise","LOCALS",1)
END

DEFAULT TRIGGER()

////////////////////////////////////////////////////////////////////////////
// Closedown
///////////////////////////////////////////////////////////////////////////


INCLUDE FILE(%scsroot%/mage/ssl/generalblocks/closedown.ssl)
