//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////               overarching clone
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

DEFINE_ACTION_FUNCTION clone_effect
    INT_VAR allow_missing = 0
    STR_VAR
           effect=""
           edits=""
           editstring=""
    BEGIN
         LAUNCH_ACTION_FUNCTION clone_template
	          INT_VAR allow_missing
                  STR_VAR file_list= ~%effect%~
                          file_ext=~EFF~
                          edits= ~%edits%~
                          editstring= ~%editstring%~
         END
END


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////               overarching edit
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

DEFINE_ACTION_FUNCTION edit_effect
    INT_VAR allow_missing = 0
    STR_VAR
           effect=""
           edits=""
           editstring=""
    BEGIN
         LAUNCH_ACTION_FUNCTION edit_template
	          INT_VAR allow_missing
                  STR_VAR file_list= ~%effect%~
                          file_ext=~EFF~
                          edits
                          editstring
         END
END

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////               overarching make
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

DEFINE_ACTION_FUNCTION make_effect
    STR_VAR
           effect=""
           edits=""
           editstring=""
    BEGIN
         LAUNCH_ACTION_FUNCTION make_template
                  STR_VAR file_list= ~%effect%~
                          file_ext=~EFF~
                          edits= ~%edits%~
                          editstring= ~%editstring%~
                          build_before= EFF_build
         END
END

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////               overarching install
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

DEFINE_ACTION_FUNCTION install_effect
    STR_VAR
           effect=""
           edits=""
           editstring=""
           location=""
           locbase=""
           locabs=""
    BEGIN
         LAUNCH_ACTION_FUNCTION install_template
                  STR_VAR file_list= ~%effect%~
                          file_ext=~EFF~
                          edits
                          editstring
                          location locbase locabs
         END
END

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////               simple data-field edits
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

ACTION_DEFINE_ASSOCIATIVE_ARRAY eff_fields BEGIN
   opcode => ~0x10,LONG~
   target => ~0x14,LONG~
   power => ~0x18,LONG~
   parameter1=>~0x1c,LONG~
   parameter2=>~0x20,LONG~
   parameter2a=>~0x20,SHORT~
   parameter2b=>~0x22,SHORT~
   timing=>~0x24,SHORT~
   duration=>~0x28,LONG~
   probability1=>~0x2c,SHORT~
   probability2=>~0x2e,SHORT~
   resource=>~0x30,ASCII~
   dicenum=>~0x38,LONG~
   dicesize=>~0x3c,LONG~
   savebonus=>~0x44,LONG~
   resistance=>~0x5c,LONG~
   resist_dispel=>~0x5c,LONG~
   parameter3=>"0x60,LONG"
   parameter4=>"0x64,LONG"
   vvc=>~0x70,ASCII~
   resource2=>~0x70,ASCII~
   caster_xloc=>"0x80,LONG"
   caster_yloc=>"0x84,LONG"
   target_xloc=>"0x88,LONG"
   target_yloc=>"0x8c,LONG"

   //many others; I'll stop there
END

LAUNCH_ACTION_FUNCTION build_simple_data_field_editors STR_VAR lookup_table=eff_fields function_prefix=EFF END


ACTION_DEFINE_ASSOCIATIVE_ARRAY eff_bit_fields BEGIN
      save_vs_spell=>~0x40,0~
      save_spells=>~0x40,0~
      save_vs_breath=>~0x40,1~
      save_breath=>~0x40,1~
      save_vs_death=>~0x40,2~
      save_death=>~0x40,2~
      save_vs_wand=>~0x40,3~
      save_wands=>~0x40,3~
      save_vs_polymorph=>~0x40,4~
      save_polymorph=>~0x40,4~
      bypass_mirror_image=>~0x43,0~
      fist_only=>~0x48,2~
END

LAF build_flag_data_field_editors STR_VAR lookup_table=eff_bit_fields function_prefix=EFF END



//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////// build a basic effect
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

DEFINE_PATCH_FUNCTION EFF_build
BEGIN
   ///// basic structure
   DELETE_BYTES 0x0 BUFFER_LENGTH
   INSERT_BYTES 0x0 0x110

   // sig
   WRITE_ASCII 0x0 ~EFF V2.0~
   WRITE_ASCII 0x8 ~EFF V2.0~
   // start off with probability 100
   WRITE_BYTE 0x2c 100
   // unknown fields, copied blindly from example file
   WRITE_LONG 0x80 0xffffffff
   WRITE_LONG 0x84 0xffffffff
   WRITE_LONG 0x88 0xffffffff
   WRITE_LONG 0x8c 0xffffffff
   WRITE_LONG 0xa4 0xffffffff
END


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////// make an effect that casts a spell
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

DEFINE_ACTION_FUNCTION make_casting_effect
    INT_VAR target=2
    STR_VAR effect=""
            spell=""
BEGIN
   ACTION_CLEAR_ARRAY patch_data
   ACTION_DEFINE_ASSOCIATIVE_ARRAY patch_data BEGIN
       opcode=>146
       target=>~%target%~
       parameter2=>1
       timing=>1
       parameter1=>1
       resource=>~%spell%~
   END
   LAF make_effect STR_VAR effect edits=patch_data END



END
